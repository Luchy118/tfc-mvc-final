@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/_LayoutPage1.cshtml";
}

@section Styles{
    <style>
        .tableheader {
            background-color: dimgray;
            color: white;
        }

        main {
            align-content: unset;
        }

        .nav-tabs .nav-link.active {
            background-color: dimgray;
            color: white;
        }

        .nav-tabs .nav-link {
            color: dimgray;
        }

        .table td {
            vertical-align: middle;
        }

        .table .form-control {
            display: inline-block;
            width: auto;
        }

        .fa-trash {
            color: red;
            cursor: pointer;
        }

        .fa-plus {
            color: green;
            cursor: pointer;
        }

        .dropdown-item {
            cursor: pointer;
        }

            .dropdown-item:hover {
                background-color: #9b9b9b;
            }
    </style>
}

@section Scripts{
    <script>
        var filasTablaAniadidos = 1;
        var selectPorDefecto = "--- Seleccione un SKU ---";
        var zapas = [];
        var datatable;

        $(function () {
            $("body").addClass("sub_page");
            $(".footer_section").addClass("fixedFooter");

            $("#navbarSupportedContent li.nav-item").each(function () {
                if ($(this).hasClass("active")) {
                    $(this).removeClass("active");
                }

                if ($(this).find("a").text() == "Área de usuarios") {
                    $(this).addClass("active");
                }
            });

            datatable = $("#tablaInventario").DataTable({
                responsive: true,
                ajax: {
                    url: "@Url.Action("GetInventoryData", "Usuarios")",
                    method: "POST",
                    dataType: 'json',
                    contentType: 'application/json'
                },
                columns: [
                    { data: "SKU" },
                    { data: "Nombre" },
                    { data: "Cantidad" },
                    {
                        data: "Precio",
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return data + " €";
                            }
                            return data;
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            if (type === 'display' || type === 'filter') {
                                return (row.Precio * row.Cantidad) + " €";
                            }
                            return row.Precio * row.Cantidad;
                        }
                    },
                    {
                        data: "SKU",
                        render: (clave) => "<div id='divBtnDetalles' style='text-align: center'><a class='btn btn-default btn-sm' style='height: 25px;margin-bottom: 5px; cursor: pointer' href='@Url.Action("InventoryRowDetails")?sku=" + clave.trim() + "'><i class='fa fa-pencil'></i></a></div>",
                        orderable: false,
                        searchable: false,
                        width: "33px"
                    }
                ],
                language: {
                    "search": "Búsqueda",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "lengthMenu": "Mostrando _MENU_ registros",
                    "info": "Mostrando del _START_ al _END_ de un total de _TOTAL_ registros",
                    "emptyTable": "No se han encontrado datos.",
                    "infoFiltered": "",
                    "paginate": {
                        "previous": "Anterior",
                        "next": "Siguiente"
                    }
                },
                lengthMenu: [10, 25, 50, 100, 1000]
            });

            cargarZapas();
        });

        $(document).on("click", function (event) {
            var dropdownMenus = $(".dropdown-menu");
            dropdownMenus.each(function () {
                if (!$(event.target).closest(this).length) {
                    $(this).parent().css("display", "none");
                }
            });
        });

        function cargarZapas() {
            $.ajax({
                url: "@Url.Action("GetSKUNombreDescripcion", "Usuarios")",
                type: "GET",
                success: function(data) {
                    zapas = data;
                    inicializarTabla();
                },
                error: function(xhr, status, error) {
                    console.error("Error en func cargarZapas():", error);
                }
            });
        }

        function crearFila(indice) {
            var fila =
            `<tr data-indice="${indice}">
                <td>
                    <input type="text" class="form-control sku-input" data-indice="${indice}" placeholder="Buscar SKU o Nombre" maxlength="50">
                    <div class="dropdown">
                        <ul class="dropdown-menu" data-indice="${indice}" style="display:none;"></ul>
                    </div>
                </td>
                <td>
                    <input type="text" style="width: 100%;" class="form-control nombre-input" data-indice="${indice}" disabled />
                </td>
                <td>
                    <input type="text" style="width: 100%;" class="form-control descripcion-input" data-indice="${indice}" disabled />
                </td>
                <td>
                    <input type="number" style="width: 100%;" class="form-control precio-input" data-indice="${indice}" placeholder="Precio" min="1" step="0.01" />
                </td>
                <td>
                    <i class="fa fa-trash clear-row" data-indice="${indice}"></i>
                </td>
            </tr>`;
            return fila;
        }

        function agregarFila(aftermax) {
            if ((filasTablaAniadidos <= zapas.length && filasTablaAniadidos <= 10) || (aftermax == true && filasTablaAniadidos <= zapas.length)) {
                var nuevaFila = crearFila(filasTablaAniadidos);
                $("#tablaAgregarArticulos tbody").append(nuevaFila);
                filasTablaAniadidos++;
            }

            if (filasTablaAniadidos > zapas.length) {
                $("#tablaAgregarArticulos tfoot").hide();
            }
        }

        $("#tablaAgregarArticulos").on("input", ".sku-input", function () {
            var indice = $(this).data("indice");
            var terminoBusqueda = $(this).val().toLowerCase();
            var menuDesplegable = $(this).next(".dropdown").find(".dropdown-menu");
            var valorSKU = $(this).val();
            if (valorSKU == "") {
                vaciarCampos(indice);
            }
            menuDesplegable.empty();
            var resultados = [];
            for (var i = 0; i < zapas.length; i++) {
                var sku = zapas[i].SKU.toLowerCase();
                var nombre = (zapas[i].Nombre || "").toLowerCase();
                if ((sku.includes(terminoBusqueda) || nombre.includes(terminoBusqueda)) && !estaSeleccionado(sku, indice)) {
                    resultados.push(zapas[i]);
                }
            }
            for (var j = 0; j < resultados.length; j++) {
                menuDesplegable.append(`<li class="dropdown-item" data-indice="${indice}" data-sku="${resultados[j].SKU}" data-nombre="${resultados[j].Nombre != null ? resultados[j].Nombre : "Sin nombre"}" data-descripcion="${resultados[j].Descripcion != null ? resultados[j].Descripcion : "Sin descripción"}">${resultados[j].SKU} | ${resultados[j].Nombre}</li>`);
            }
            if (resultados.length == 0) {
                menuDesplegable.append(`<li class="dropdown-item" data-indice="${indice}" disabled>Sin resultados</li>`);
            }

            menuDesplegable.parent().css("display", "block");
            menuDesplegable.css("display", "block");
        });

        function estaSeleccionado(sku, indiceActual) {
            var skusSeleccionados = $(".sku-input").map(function () {
                var indice = $(this).data("indice");
                if (indice !== indiceActual) {
                    return $(this).val().toLowerCase();
                }
            }).get();
            return skusSeleccionados.includes(sku);
        }

        $("#tablaAgregarArticulos").on("click", ".dropdown-item", function () {
            var indice = $(this).data("indice");
            var sku = $(this).data("sku");
            var nombre = $(this).data("nombre");
            var descripcion = $(this).data("descripcion");
            $(`.sku-input[data-indice=${indice}]`).val(sku);
            $(`.nombre-input[data-indice=${indice}]`).val(nombre);
            $(`.descripcion-input[data-indice=${indice}]`).val(descripcion);
            $(this).closest(".dropdown").css("display", "none");
        });

        $("#tablaAgregarArticulos").on("click", ".clear-row", function() {
            var indice = $(this).data("indice");
            vaciarCampos(indice);
        });

        $("#tablaAgregarArticulos").on("click", ".add-row", function () {
            agregarFila(true);
        });

        $("#botonGuardar").on("click", function () {
            var filasConContenido = [];

            $("#tablaAgregarArticulos tbody tr").each(function () {
                var indice = $(this).data("indice");
                var sku = $(this).find(".sku-input").val();
                var precio = $(`.precio-input[data-indice=${indice}]`).val();

                if (sku) {
                    if (!precio || precio <= 0) {
                        mostrarError("Error", "El precio no puede ser nulo o negativo.");
                        esValido = false;
                        return false;
                    }
                    filasConContenido.push({
                        SKU: sku,
                        Precio: parseFloat(precio)
                    });
                }
            });

            if (filasConContenido.length > 0) {
                $.ajax({
                    url: "@Url.Action("AddZapas", "Usuarios")",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(filasConContenido),
                    success: function (response) {
                        if (response.success) {
                            mostrarExito("Datos guardados correctamente.");
                            limpiarCamposTabla();
                            cargarZapas();
                        } else {
                            mostrarError(response.message);
                            datatable.ajax.reload();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("Error en botonGuardar -> onclick -> ajax: " + error);
                    }
                });
            } else {
                mostrarError("Debe haber al menos una fila rellena.");
            }
        });

        function inicializarTabla() {
            var totalSkus = zapas.length;
            for (var i = 0; i < totalSkus && i < 10; i++) {
                agregarFila();
            }

            if (totalSkus > 10) {
                $("#tablaAgregarArticulos tfoot").show();
            } else {
                $("#tablaAgregarArticulos tfoot").hide();
            }
        }

        function vaciarCampos(fila) {
            var elementoFila = $("#tablaAgregarArticulos").find("tr[data-indice=" + fila + "]");
            $(elementoFila).find("select").val("");
            $(elementoFila).find("input").val("");
            $(elementoFila).find(".descripcion").text("");
            $(elementoFila).find(".precio").text("");
        }

        function limpiarCamposTabla() {
            $("#tablaAgregarArticulos input").val("");
        }

        function getUrlBase() {
            let urlPartida = window.location.toString().split("/");
            urlPartida.length = 3;
            return urlPartida.join("/");
        }

        function cargarInforme() {
            $.ajax({
                url: "@Url.Action("Informe")",
                success: () => { window.open(getUrlBase() + "/PaginaInforme.aspx").focus; },
                error: "Error"
            });
        }
    </script>
}

<section class="layout_padding">
    <div class="container">
        <div class="heading_container heading_center mb-5">
            <h2>Área de Usuarios</h2>
        </div>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="inventory-tab" data-toggle="tab" href="#inventory" role="tab" aria-controls="inventory" aria-selected="true">Inventario</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="agregar-articulo-tab" data-toggle="tab" href="#agregar-articulo" role="tab" aria-controls="agregar-articulo" aria-selected="false">Agregar Artículo</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="summary-tab" data-toggle="tab" href="#summary" role="tab" aria-controls="summary" aria-selected="false">Resumen</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="statistics-tab" data-toggle="tab" href="#statistics" role="tab" aria-controls="statistics" aria-selected="false">Estadísticas</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                <div class="row" style="margin-top: 50px">
                    <div class="col-12 mb-2">
                        <button id="botonGenerarInforme" class="btn btn-primary" onclick="cargarInforme()">Generar Informe</button>
                    </div>
                    <div class="col-12">
                        <table id="tablaInventario" class="table table-striped table-bordered nowrap" style="width: 100%" cellspacing="0">
                            <thead class="tableheader">
                                <tr>
                                    <th>SKU</th>
                                    <th>Artículo</th>
                                    <th>Cantidad</th>
                                    <th>Tu precio/unidad</th>
                                    <th>Valor total</th>
                                    <th>Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="agregar-articulo" role="tabpanel" aria-labelledby="agregar-articulo-tab">
                <div class="row" style="margin-top: 50px">
                    <div class="col-12" style="max-height: 800px; overflow-y: auto">
                        <h3>Agregar Artículo al Inventario</h3>
                        <table id="tablaAgregarArticulos" class="table table-bordered">
                            <thead class="tableheader">
                                <tr>
                                    <th style="width: 20%;">SKU</th>
                                    <th style="width: 30%;">Nombre</th>
                                    <th style="width: 30%;">Descripción</th>
                                    <th style="width: 20%">Precio</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td>
                                        <i class="fa fa-plus add-row"></i>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="col-12 mt-5">
                        <button id="botonGuardar" class="btn btn-success">Guardar</button>
                        <button id="botonBorrarCampos" class="btn btn-danger" onclick="limpiarCamposTabla()">Borrar Campos</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                <div class="row" style="margin-top: 50px">
                    <div class="col-12">
                        <h3>Resumen del Inventario</h3>
                        <p>Aquí puedes mostrar un resumen del inventario del usuario, como el número total de artículos, el valor total del inventario, etc.</p>
                        <!-- Añadir más contenido según sea necesario -->
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="statistics" role="tabpanel" aria-labelledby="statistics-tab">
                <div class="row" style="margin-top: 50px">
                    <div class="col-12">
                        <h3>Estadísticas</h3>
                        <p>Aquí puedes mostrar estadísticas relevantes, como los artículos más vendidos, las tendencias de ventas, etc.</p>
                        <!-- Añadir gráficos y otros elementos de visualización de datos según sea necesario -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>